# -------------------------------
# Base image
# -------------------------------
    FROM elixir:latest

    # -------------------------------
    # System dependencies
    # -------------------------------
    RUN apt-get update && apt-get install -y \
        curl \
        wget \
        git \
        build-essential \
        postgresql-client \
        inotify-tools \
        && rm -rf /var/lib/apt/lists/*
    
    # -------------------------------
    # Node.js for assets
    # -------------------------------
    RUN curl -fsSL https://deb.nodesource.com/setup_18.x | bash - \
        && apt-get install -y nodejs
    
    # -------------------------------
    # Hex and Rebar
    # -------------------------------
    RUN mix local.hex --force && mix local.rebar --force
    
    # -------------------------------
    # Set working directory
    # -------------------------------
    WORKDIR /app
    ENV MIX_ENV=prod
    
    # -------------------------------
    # Copy only what's needed for dependencies first (caching)
    # -------------------------------
    COPY mix.* ./
    COPY config ./config
    
    # -------------------------------
    # Install Elixir dependencies
    # -------------------------------
    RUN mix deps.get --only prod
    RUN mix deps.compile
    
    # -------------------------------
    # Copy the rest of the app
    # -------------------------------
    COPY lib ./lib
    COPY priv ./priv
    COPY assets ./assets
    
    # -------------------------------
    # Install Node dependencies and build assets
    # -------------------------------
    WORKDIR /app/assets
    RUN npm ci
    RUN npm run deploy  # Phoenix 1.7+ alias: mix assets.deploy will use minified assets
    
    # -------------------------------
    # Build assets into priv/static
    # -------------------------------
    WORKDIR /app
    RUN mix assets.deploy
    
    # -------------------------------
    # Compile the Elixir app
    # -------------------------------
    RUN mix compile
    
    # -------------------------------
    # Expose port
    # -------------------------------
    EXPOSE 4000
    
    # -------------------------------
    # Start script
    # -------------------------------
    COPY start.sh /usr/local/bin/start.sh
    RUN chmod +x /usr/local/bin/start.sh
    CMD ["/usr/local/bin/start.sh"]
    